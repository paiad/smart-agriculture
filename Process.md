# 数据处理流程 (Process.md)

## 一、设备数据上报流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              设备数据上报流程                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

  ┌──────────┐                    ┌──────────┐                    ┌──────────────┐
  │   设备   │ ───── MQTT ──────▶ │   EMQX   │ ──── subscribe ──▶ │ Spring Boot │
  │ (传感器) │                    │  Broker  │                    │   后端服务   │
  └──────────┘                    └──────────┘                    └──────────────┘
       │                                                                 │
       │  Topic: smart-agri/data/{deviceId}                              │
       │  Payload: { deviceId, temperature, humidity, ... }              │
       │                                                                 ▼
       │                                                    ┌────────────────────┐
       │                                                    │  MqttService       │
       │                                                    │  .messageArrived() │
       │                                                    └─────────┬──────────┘
       │                                                              │
       │                                                              ▼
       │                                              ┌───────────────────────────┐
       │                                              │ 1. 解析 Topic 获取 deviceId │
       │                                              │    topicParts[2]          │
       │                                              └─────────────┬─────────────┘
       │                                                            │
       │                                                            ▼
       │                                              ┌───────────────────────────┐
       │                                              │ 2. JSON 解析 Payload      │
       │                                              │    JSONUtil.toBean()      │
       │                                              └─────────────┬─────────────┘
       │                                                            │
       │                                                            ▼
       │                                              ┌───────────────────────────┐
       │                                              │ 3. deviceId 一致性校验     │
       │                                              │    Topic vs Payload       │
       │                                              └─────────────┬─────────────┘
       │                                                            │
       │                                                            ▼
       │                                              ┌───────────────────────────┐
       │                                              │ 4. 设备注册校验            │
       │                                              │    DeviceService.getOne() │
       │                                              └─────────────┬─────────────┘
       │                                                            │
       │                                                            ▼
       │                                              ┌───────────────────────────┐
       │                                              │ 5. 更新设备心跳            │
       │                                              │    updateHeartbeat()      │
       │                                              └─────────────┬─────────────┘
       │                                                            │
       │                                                            ▼
       │                                              ┌───────────────────────────┐
       │                                              │ 6. 处理并保存数据          │
       │                                              │    EnvDataService         │
       │                                              │    .processAndSave()      │
       │                                              └─────────────┬─────────────┘
                                                                    │
                                            ┌───────────────────────┴───────────────────────┐
                                            │                                               │
                                            ▼                                               ▼
                              ┌─────────────────────────┐                     ┌─────────────────────────┐
                              │  保存 EnvData 到 MySQL   │                     │   告警规则检测           │
                              │  env_data 表            │                     │   checkAndGenerateAlarms │
                              └─────────────────────────┘                     └─────────────┬───────────┘
                                                                                            │
                                                                                            ▼
                                                                              ┌─────────────────────────┐
                                                                              │ 从 Redis 获取告警规则    │
                                                                              │ smart-agri:alarm-rules  │
                                                                              └─────────────┬───────────┘
                                                                                            │
                                                                                            ▼
                                                                              ┌─────────────────────────┐
                                                                              │ 匹配规则 & 阈值比对      │
                                                                              │ (minValue / maxValue)   │
                                                                              └─────────────┬───────────┘
                                                                                            │
                                                                        ┌───────────────────┴────────────────────┐
                                                                        │ 触发告警?                              │
                                                                        └───────────────────┬────────────────────┘
                                                                                            │
                                                              ┌─────────────────────────────┴─────────────────────┐
                                                              │ YES                                               │ NO
                                                              ▼                                                   ▼
                                                ┌─────────────────────────┐                              ┌──────────────┐
                                                │ 保存 Alarm 到 MySQL     │                              │    结束      │
                                                │ alarm 表                │                              └──────────────┘
                                                └─────────────────────────┘
```

---

## 二、数据流向图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    数据流向总览                                           │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                                       ┌─────────────┐
                                       │   IoT 设备  │
                                       │  (传感器)   │
                                       └──────┬──────┘
                                              │
                                              │ MQTT Publish
                                              │ Topic: smart-agri/data/{deviceId}
                                              ▼
                                       ┌─────────────┐
                                       │    EMQX     │
                                       │   Broker    │
                                       └──────┬──────┘
                                              │
                                              │ MQTT Subscribe
                                              ▼
┌──────────────────────────────────────────────────────────────────────────────────────────┐
│                                Spring Boot Backend                                        │
│                                                                                          │
│  ┌────────────────┐      ┌──────────────────┐      ┌───────────────────┐                 │
│  │   MqttService  │ ───▶ │  EnvDataService  │ ───▶ │   EnvDataMapper   │                 │
│  │  (消息接收)     │      │  (业务处理)       │      │   (数据持久化)    │                 │
│  └────────────────┘      └────────┬─────────┘      └─────────┬─────────┘                 │
│                                   │                          │                           │
│                                   │                          ▼                           │
│                                   │                 ┌─────────────────┐                  │
│                                   │                 │     MySQL       │                  │
│                                   │                 │   env_data 表   │                  │
│                                   │                 └─────────────────┘                  │
│                                   │                                                      │
│                                   │ 告警检测                                              │
│                                   ▼                                                      │
│                          ┌──────────────────┐                                            │
│                          │ AlarmRuleService │◀───────┐                                   │
│                          │   (规则匹配)      │        │ 缓存读取                          │
│                          └────────┬─────────┘        │                                   │
│                                   │            ┌─────┴─────────┐                         │
│                                   │            │    Redis      │                         │
│                                   │            │ (告警规则缓存) │                         │
│                                   │            └───────────────┘                         │
│                                   │                                                      │
│                                   │ 规则触发                                              │
│                                   ▼                                                      │
│                          ┌──────────────────┐      ┌─────────────────┐                   │
│                          │   AlarmService   │ ───▶ │     MySQL       │                   │
│                          │   (告警生成)      │      │   alarm 表      │                   │
│                          └──────────────────┘      └─────────────────┘                   │
│                                                                                          │
└──────────────────────────────────────────────────────────────────────────────────────────┘
                                              │
                                              │ REST API
                                              ▼
                                       ┌─────────────┐
                                       │   Vue 3     │
                                       │   前端应用   │
                                       └─────────────┘
```

---

## 三、核心类职责

| 类名               | 职责                           |
| ------------------ | ------------------------------ |
| `MqttService`      | MQTT 回调处理，消息路由分发    |
| `EnvDataService`   | 环境数据保存，告警规则检测触发 |
| `DeviceService`    | 设备注册校验，心跳更新         |
| `AlarmRuleService` | 告警规则管理，Redis 缓存同步   |
| `AlarmService`     | 告警记录生成与存储             |

---

## 四、校验顺序优化

为降低 I/O 开销，校验顺序按 **内存优先** 原则排列：

```
1. JSON 解析          (CPU, 无 I/O)
2. deviceId 一致性    (内存比对, 无 I/O)
3. 设备注册查询       (MySQL I/O)
```

---

## 五、控制指令下发流程 (CMD)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              控制指令下发流程                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

  ┌──────────┐                    ┌──────────────┐                    ┌──────────┐
  │  前端 UI  │ ─── HTTP POST ───▶│ Spring Boot │ ───── MQTT ──────▶ │   EMQX   │
  │ (Vue 3)  │                    │   后端服务   │                    │  Broker  │
  └──────────┘                    └──────────────┘                    └────┬─────┘
       │                                 │                                 │
       │  POST /control-command/send     │                                 │
       │  Body: { deviceId, command,     │                                 │
       │          params }               │                                 │
       │                                 ▼                                 │
       │                    ┌────────────────────────┐                     │
       │                    │ ControlCommandController│                     │
       │                    │ .send()                │                     │
       │                    └───────────┬────────────┘                     │
       │                                │                                  │
       │                                ▼                                  │
       │                    ┌────────────────────────┐                     │
       │                    │ 1. 生成 requestId      │                     │
       │                    │    IdUtil.fastSimpleUUID │                   │
       │                    └───────────┬────────────┘                     │
       │                                │                                  │
       │                                ▼                                  │
       │                    ┌────────────────────────┐                     │
       │                    │ 2. 构建 ControlCommand  │                     │
       │                    │    status = 1 (已发送)  │                     │
       │                    └───────────┬────────────┘                     │
       │                                │                                  │
       │                                ▼                                  │
       │                    ┌────────────────────────┐                     │
       │                    │ 3. 发送 MQTT 消息       │                     │
       │                    │    MqttService.publish()│                    │
       │                    │    Topic: smart-agri/   │                    │
       │                    │    cmd/{deviceId}       │                    │
       │                    └───────────┬────────────┘                     │
       │                                │                                  │
       │                                ▼                                  │
       │                    ┌────────────────────────┐                     │
       │                    │ 4. 保存指令记录到 MySQL │                     │
       │                    │    control_command 表  │                     │
       │                    └───────────┬────────────┘                     │
       │                                │                                  ▼
       │                                │                        ┌─────────────────┐
       │                                │                        │  MQTT Publish   │
       │                                │                        │  到指定设备      │
       │                                │                        └────────┬────────┘
       │                                │                                 │
       │◀─── 返回 requestId ────────────┤                                 │
       │     用于状态查询                │                                 │
       │                                │                                 ▼
       │                                │                        ┌─────────────────┐
       │                                │                        │   IoT 设备      │
       │                                │                        │   执行指令      │
       │                                │                        └─────────────────┘
```

### 指令 Payload 格式

```json
{
  "deviceId": "device_001",
  "command": "IRRIGATION_ON",
  "params": { "duration": 30, "intensity": "high" },
  "requestId": "a1b2c3d4e5f6",
  "status": 1,
  "sentAt": "2026-01-21T22:00:00"
}
```

---

## 六、ACK 确认流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                               ACK 确认流程                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

  ┌──────────┐                    ┌──────────┐                    ┌──────────────┐
  │  IoT 设备 │ ───── MQTT ──────▶│   EMQX   │ ──── subscribe ──▶ │ Spring Boot │
  │ (执行完成) │                   │  Broker  │                    │   后端服务   │
  └──────────┘                    └──────────┘                    └──────────────┘
       │                                                                 │
       │  Topic: smart-agri/ack/{deviceId}                               │
       │  Payload: { requestId, success, errorMsg }                      │
       │                                                                 ▼
       │                                                    ┌────────────────────┐
       │                                                    │  MqttService       │
       │                                                    │  .messageArrived() │
       │                                                    └─────────┬──────────┘
       │                                                              │
       │                                                              ▼
       │                                                    ┌────────────────────┐
       │                                                    │   handleAck()      │
       │                                                    └─────────┬──────────┘
       │                                                              │
       │                                                              ▼
       │                                              ┌───────────────────────────┐
       │                                              │ 1. 解析 Topic 获取 deviceId │
       │                                              └─────────────┬─────────────┘
       │                                                            │
       │                                                            ▼
       │                                              ┌───────────────────────────┐
       │                                              │ 2. 更新设备心跳            │
       │                                              │    updateHeartbeat()      │
       │                                              └─────────────┬─────────────┘
       │                                                            │
       │                                                            ▼
       │                                              ┌───────────────────────────┐
       │                                              │ 3. 解析 ACK JSON          │
       │                                              │    requestId, success     │
       │                                              └─────────────┬─────────────┘
       │                                                            │
       │                                                            ▼
       │                                              ┌───────────────────────────┐
       │                                              │ 4. 根据 requestId 查找指令 │
       │                                              │    ControlCommandService  │
       │                                              └─────────────┬─────────────┘
       │                                                            │
       │                                                            ▼
       │                                              ┌───────────────────────────┐
       │                                              │ 5. 更新指令状态           │
       │                                              │    success=true  → 2 (成功)│
       │                                              │    success=false → 3 (失败)│
       │                                              │    设置 ackAt, errorMsg   │
       │                                              └─────────────┬─────────────┘
       │                                                            │
       │                                                            ▼
       │                                              ┌───────────────────────────┐
       │                                              │ 6. 保存更新到 MySQL       │
       │                                              │    control_command 表     │
       │                                              └───────────────────────────┘
```

### ACK Payload 格式

```json
{
  "requestId": "a1b2c3d4e5f6",
  "success": true,
  "errorMsg": null
}
```

### 指令状态码

| 状态码 | 含义   | 说明                               |
| ------ | ------ | ---------------------------------- |
| 1      | 已发送 | 指令已通过 MQTT 发送，等待设备响应 |
| 2      | 成功   | 设备执行成功并返回 ACK             |
| 3      | 失败   | 设备执行失败，errorMsg 包含原因    |
| 4      | 超时   | 超过 30 秒未收到 ACK               |

---

## 七、完整闭环时序图

```
┌──────────┐      ┌──────────────┐      ┌──────────┐      ┌──────────┐
│  前端 UI  │      │  Spring Boot │      │   EMQX   │      │  IoT 设备 │
└────┬─────┘      └──────┬───────┘      └────┬─────┘      └────┬─────┘
     │                   │                   │                 │
     │  POST /send       │                   │                 │
     │ ─────────────────▶│                   │                 │
     │                   │                   │                 │
     │                   │  MQTT Publish     │                 │
     │                   │  (cmd/deviceId)   │                 │
     │                   │ ─────────────────▶│                 │
     │                   │                   │                 │
     │   { requestId }   │                   │  Forward        │
     │ ◀─────────────────│                   │ ────────────────▶
     │                   │                   │                 │
     │                   │                   │                 │  执行指令
     │                   │                   │                 │ ─────────
     │                   │                   │                 │
     │                   │                   │  MQTT Publish   │
     │                   │                   │  (ack/deviceId) │
     │                   │                   │ ◀────────────────
     │                   │                   │                 │
     │                   │  Forward          │                 │
     │                   │ ◀─────────────────│                 │
     │                   │                   │                 │
     │                   │  Update status    │                 │
     │                   │ ─────────────     │                 │
     │                   │                   │                 │
     │  GET /status/{id} │                   │                 │
     │ ─────────────────▶│                   │                 │
     │                   │                   │                 │
     │   { status: 2 }   │                   │                 │
     │ ◀─────────────────│                   │                 │
     │                   │                   │                 │
```

---

## 八、关键 Topic 定义

| Topic                        | 方向          | 说明         |
| ---------------------------- | ------------- | ------------ |
| `smart-agri/data/{deviceId}` | 设备 → 服务端 | 环境数据上报 |
| `smart-agri/cmd/{deviceId}`  | 服务端 → 设备 | 控制指令下发 |
| `smart-agri/ack/{deviceId}`  | 设备 → 服务端 | 指令执行确认 |
